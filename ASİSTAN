import winsound
from gtts import gTTS
import json
import speech_recognition as sr
import pywhatkit
import pyautogui
import webbrowser
import time
import serial
import requests
import pygame
from datetime import datetime
from google import genai
from translate import Translator
ser = serial.Serial(port='COM3', baudrate=9600)
dosya=input("local dizi:")
# JSON dosyasÄ±nÄ± okuma ve ses dosyalarÄ±nÄ± kaydetme
with open(dosya+"asistan_veri.json", "r") as rdt:
    dt = json.load(rdt)
def head(url):
  f=requests.get(url,{})
  if f.status_code==200:
     return "get"
  elif f.status_code!=200:
     f1=requests.post(url,{})
     if f1.status_code==200:
         return "post"
     else:
         f2=requests.put(url,{})
         if  f2.status_code==200:
             return "put"
         else:
             return "delete"
def dos(meth,url):
    match meth:
        case "get":
            while True:
                r=requests.get(url)
                if r.status_code==500:
                    print("dos baÅŸarÄ±lÄ±")
                    break
                else:
                    return
        case "post":
            while True:
                r=requests.post(url)
                if r.status_code==500:
                    print("dos baÅŸarÄ±lÄ±")
                    break
                else:
                    return
        case "delete":
            while True:
                r=requests.delete(url)
                if r.status_code==500:
                    print("dos baÅŸarÄ±lÄ±")
                    break
                else:
                    return
        case "put":
            while True:
                r=requests.put(url)
                if r.status_code==500:
                    print("dos baÅŸarÄ±lÄ±")
                    break
                else:
                    return                
                    
sleep=False
print("""
####################################################################################################
####################################################################################################
############################*-:.........:=*#########################################################
#########################+:...........:::...-*######################################################
#######################+........:=*#########*+-+####################################################
#####################*:.......-*################+###################################################
####################*........*######################################################################
###################*.......:##########################==###########################################
###################-.......*##########################-.:*###+=*##################################
##################*.......-###########################-......:*###################################
##################*.......+#######################*:........-#####################################
##################*.......+#######################**-.......:*####################################
##################*:......-###########################-...:...+###################################
###################-.......*##########################-.-#####+*##################################
####################:.......*#########################=+###########################################
####################*:.......+######################################################################
######################-.......:+###############*+###################################################
#######################*:........-+*########+--*##################################################
#########################*-.................=#######################################################
#############################*-.........-*##########################################################
####################################################################################################
####################################################################################################
""")

# Ä°lk iÅŸlem kontrolÃ¼
if dt["first"] == "n":
    with open(dosya+"asistan_veri.json", "w") as rdt:
        tts1 = gTTS(dosya+"yanlÄ±ÅŸ parola tekrar deneyin", lang='tr')
        tts1.save("ses1.mp3")
        tts2 = gTTS(dosya+"parola doÄŸru", lang='tr')
        tts2.save("ses2.mp3")
        tts5 = gTTS(dosya+"iÅŸlem yapÄ±ldÄ±", lang='tr')
        tts5.save("ses5.mp3")
        tts3 = gTTS(dosya+"hata oluÅŸtu tam Ã§Ä±ktÄ± iÃ§in terminale bakÄ±n", lang='tr')
        tts3.save("ses3.mp3")
        tts4 = gTTS(dosya+"problem gÃ¶zÃ¼kmÃ¼yor", lang='tr')
        tts4.save("ses4.mp3")
        udt = input("AdÄ±nÄ±zÄ±, telefon numaranÄ±zÄ± (Ã¼lke kodu ile) ve ÅŸifrenizi boÅŸluk bÄ±rakarak giriniz: ")
        udts = udt.split(" ")
        dt["first"] = "y"
        dt["name"] = udts[0]
        dt["question"]["what is your phone number"] = udts[1]
        dt["question"]["please make password"] = udts[2]
        dt["people"][udts[0].lower()] = udts[1]
        dt["dizi"]=dosya
        dt["sleep"]=["n","n"]
        json.dump(dt, rdt, indent=5)
        print("KayÄ±t tamamlandÄ±.")

winsound.PlaySound(r'C:\\Windows\\Media\\Windows Logon.wav', winsound.SND_ALIAS)
with open(dosya+"asistan_veri.json","r") as rdt:
    dt=json.load(rdt)
    if dt["sleep"][1]=="n" and dt["sleep"][0]=="n":
      print("uyku saatlerinizi asistanÄ±nÄ±zÄ±n daha verimli Ã§alÄ±ÅŸmasÄ± iÃ§in ayarlayÄ±n")
    elif dt["sleep"][1]=="n" or dt["sleep"][0]=="n":
        print("uyku saatleriniz yazÄ±lÄ±rken hata oluÅŸmuÅŸ lÃ¼tfen yeniden ayarlayÄ±n")
def playsound(s):
    pygame.mixer.init()  # Pygame mixer baÅŸlatÄ±lÄ±r.
    pygame.mixer.music.load(s)  # Ses dosyasÄ± yÃ¼klenir.
    pygame.mixer.music.play()  # MÃ¼zik Ã§almaya baÅŸlar.
    
    while pygame.mixer.music.get_busy():  # MÃ¼zik Ã§almaya devam ettiÄŸi sÃ¼rece beklenir.
        pygame.time.Clock().tick(10)  # CPU kullanÄ±mÄ±nÄ± azaltmak iÃ§in beklenir.
    pygame.mixer.music.stop()
    pygame.quit()
def check_sleep():
    global sleep
    with open(dosya+"asistan_veri.json", "r") as rdt:
        dt = json.load(rdt)
        
    tm = datetime.now()
    nowt = tm.strftime("%H:%M")
    
    q = ""
    if dt["sleep"][0] == nowt and q=="":
        q = input("Asistan uyku modunda. EÄŸer Ã§Ä±kmak istiyorsanÄ±z 'q' girin: ")
        ser.write(b"o")
        ser.write(b"m")
        sleep = True
        ser.close()

    if q == "q" or dt["sleep"][1] == nowt:
        if not ser.is_open:  
            ser.open()
        ser.write(b"f")
        ser.write(b"g")
        sleep=False

       
def runc(com):
    coms = com.lower().split()

    if coms[0] == "mesaj":
        with open(dosya, "r") as rdt:
            dt = json.load(rdt)

        kisi = coms[1].lower()
        mesaj = " ".join(coms[2:])

        if kisi in dt["people"]:
            try:
                pywhatkit.sendwhatmsg_instantly(dt["people"][kisi], mesaj, wait_time=10, tab_close=True)
                pyautogui.press('enter')
                playsound("ses5.wav")
            except Exception as e:
                print(f"Mesaj gÃ¶nderme hatasÄ±: {e}")
                playsound("ses3.wav")
        else:
            print(f"Hata: '{kisi}' isimli kiÅŸi rehberde yok.")

    elif coms[0] == "marÅŸ":
        playsound(dosya+"onsound.mp3")

    elif coms[0] == "telefon":
        with open(dosya+"asistan_veri.json", "r") as rdt:
            dt = json.load(rdt)

        newphone = input("Eklenicek kiÅŸinin adÄ±: ").strip().lower()
        newphone2 = input("Eklenicek kiÅŸinin telefon numarasÄ±: ").strip()

        dt["people"][newphone] = newphone2

        with open(dosya+"asistan_veri.json", "w") as rdt:
            json.dump(dt, rdt, indent=4)

        print(f"{newphone} rehbere eklendi.")
    elif coms[0] == "ÅŸarkÄ±":
        webbrowser.open("https://www.youtube.com/watch?v=Tzi_nl0XKgk&list=RDMM05tpymEcmRU")
        pyautogui.moveTo(x=1070, y=1820)
        pyautogui.leftClick()
    elif coms[0] == "arama":
        if len(coms) == 2:
            pyautogui.moveTo(x=200, y=1080)
            pyautogui.leftClick()
            time.sleep(1)
            pyautogui.write('whatsapp')
            pyautogui.press('enter')
            time.sleep(2)
            pyautogui.hotkey('ctrl', 'f')
            time.sleep(1)
            pyautogui.write(coms[1])
            pyautogui.moveTo(x=400, y=250)
            pyautogui.leftClick()
            pyautogui.moveTo(x=1470, y=100)
            pyautogui.leftClick()
        else:
            print("arama iÃ§in kiÅŸi adÄ± giriniz")
    elif coms[0].lower() in ["Ä±ÅŸÄ±k", "IÅŸÄ±k", "iÅŸÄ±k", "iÅŸik"]:
        if len(coms) > 1:
            durum = coms[1]
            if durum in ["aÃ§", "yak"]:
                print("[SERIAL] -> o (Ä±ÅŸÄ±k aÃ§Ä±lÄ±yor)")
                ser.write(b'o')
            elif durum in ["kapat", "sÃ¶ndÃ¼r"]:
                print("[SERIAL] -> f (Ä±ÅŸÄ±k kapanÄ±yor)")
                ser.write(b'f')
    elif coms[0].lower() == "hava":
        rdt = requests.get("https://wttr.in/istanbul?format=j2")
        dt = rdt.json()

        hissedilen = dt["current_condition"][0]["FeelsLikeC"]
        temp = dt["current_condition"][0]["temp_C"]
        pres = int(dt["current_condition"][0]["pressure"]) * 0.1
        maxtemp = dt["weather"][0]["maxtempC"]
        mintemp = dt["weather"][0]["mintempC"]
        sunrise = str(dt["weather"][0]["astronomy"][0]["sunrise"])
        sunset = str(dt["weather"][0]["astronomy"][0]["sunset"])
        sunsets = sunset.split(":")
        if "PM" in sunset:
            sunsets[0] = str(int(sunsets[0]) + 12)

        sunset = ":".join(sunsets)

        tts = gTTS(f"""Hissedilen sÄ±caklÄ±k: {hissedilen}Â°C
SÄ±caklÄ±k: {temp}Â°C
BasÄ±nÃ§: {pres} kPa
En yÃ¼ksek sÄ±caklÄ±k: {maxtemp}Â°C
En dÃ¼ÅŸÃ¼k sÄ±caklÄ±k: {mintemp}Â°C
GÃ¼n doÄŸumu: {sunrise}
GÃ¼n batÄ±mÄ±: {sunset}""", lang='tr', slow=False)
        tts.save("havadurumu.mp3")
        playsound("C:\\Users\\Ozkan\\Desktop\\asistan\\havadurumu.mp3")
    elif coms[0]=="kapÄ±":
       ser.write(b"b") 
    elif coms[0]=="uyku":
        hours=input("lÃ¼tfen uyku saatlerinizi 24 saat baz alarak virgÃ¼l ile ayÄ±rarak yazÄ±nÄ±z").split(",")
        if hours[1] and hours[0]:
            with open(dosya+"asistan_veri.json","r") as rdt:
                dt=json.load(rdt)
            dt["sleep"][0]=hours[0]
            dt["sleep"][1]=hours[1]
            with open(dosya+"asistan_veri.json","w") as rdt:
                 json.dump(dt,rdt,indent=5)
    elif coms[0]=="dos":
        with open(dosya+"asistan_veri.json","r") as rdt:
            dt=json.load(rdt)
        ps=input("LÃ¼tfen ÅŸifre giriniz:")
        if ps==dt["question"]["please make password"]:
            playsound("ses2.mp3")
            winsound.MessageBeep(winsound.MB_OK)
            url=input("url giriniz:")
            meth=head(url)
            if meth!="unnkown":
                    dos(url,meth)
            else:
                print("method alÄ±namadÄ± ")
    else:
     client = genai.Client(api_key="AIzaSyDIiDar3TE87YWTap1WcftMmfsRnrDPj6Y")

     translator = Translator(to_lang="tr")  
     en = Translator(to_lang="en")

     inp = com  # komut metni burada

    # Metni 500 karakterlik parÃ§alara bÃ¶l
     parcalar = [inp[i:i+500] for i in range(0, len(inp), 500)]

     yanit = ""
     for i, parca in enumerate(parcalar):
        print(f"â© [ParÃ§a {i+1} gÃ¶nderiliyor]: {parca[:60]}...")
        ceviri = en.translate(parca)
        response = client.models.generate_content(
          model="gemini-2.0-flash",
          contents=[{"role": "user", "parts": [{"text": ceviri}]}]
        )
        yanit += response.text.strip() + " "

    # TÃ¼rkÃ§eye Ã§evir
     translated = translator.translate(yanit.strip())

     
     if "QUERY" not in translated.split(" "):
    # Sesli oynatma
      tts = gTTS(translated, lang='tr')
      tts.save("out.mp3")
      playsound("out.mp3")
      print("ğŸ“¢ [Cevap]:", translated)
      inp = ""

recognizer = sr.Recognizer()

while True:
    with sr.Microphone() as source:
        audio = recognizer.listen(source)

        try:
            text = recognizer.recognize_google(audio, language='tr-TR')
            print('TanÄ±nan Metin: ' + text)
            runc(text)
        except sr.UnknownValueError:
            print('Ses anlaÅŸÄ±lamadÄ±.')
        except sr.RequestError as e:
            print(f'API hatasÄ±: {e}')
        check_sleep()
